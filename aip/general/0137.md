---
id: 137
state: draft
created: 2022-09-13
updated: 2022-09-13
placement:
  category: operations
  order: 50
---

# Standard methods: Apply

Like with `Update`, when it comes to REST APIs, `Apply` is contacted via
the resource's URI. However, there are several distinct differences
between `Update` and `Apply`, the most substantial of which is that
`Apply` adheres the HTTP semantics of `PUT` rather than `PATCH`.

Two ways in which `PUT` and `PATCH` differ are in that `PUT` applies
updates to the complete resource, whether the field to update is present
or not, and also it creates resources if they do not exist, by default.
If a field is absent in the request, `Apply` assumes that the field
should be unset.

Also like `Update`, `Apply` RPCs return the resource. While `Update` is
"safer" in many cases, `Apply` is essential for resources that wish to
work with declarative clients because they rely on its symetry with
`Get`.

## Guidance

APIs **must** proivde an apply method for resources if they are to be
part of a Uniform Resource Provider ([AIP-129][]). Otherwise, they
**may** do so but **should** consider `Update` as an alternative. The
purpose of the apply mthod is to make changes to or create a resource
using the complete body of the resource.

Apply methods are specified using the following pattern:

```proto
rpc ApplyBook(ApplyBookRequest) returns (Book) {
  option (google.api.http) = {
    patch: "/v1/{book.name=publishers/*/books/*}"
    body: "book"
  };
  option (google.api.method_signature) = "book";
}
```

- The RPC's name **must** begin with the word `Apply`. The remainder of the
  RPC name **should** be the singular form of the resource's message name.
- The request message **must** match the RPC name, with a `Request` suffix.
- The response message **must** be the resource itself. (There is no
  `ApplyBookResponse`.)
  - The response **must** include the fully-populated resource unless they
    are input only (see AIP-203).
  - If the apply RPC is [long-running](#long-running-apply), the response
    message **must** be a `google.longrunning.Operation` which resolves to the
    resource itself.
- The HTTP verb **must** be `PUT` and **should** not support partial
  resource updates.
- The resource's `name` field **must** map to the URI path for Uniform
  Resource Providers and **should** be otherwise.
- There **must** be a `body` key in the `google.api.http` annotation, and it
  **must** map to the resource field in the request message.
  - All remaining fields **should** map to URI query parameters.
- There **should** be exactly one `google.api.method_signature` annotation,
  with a value of `"{resource}"`.

**Note:** Like with `Update`, but unlike the remaining standard methods,
the URI path here references a nested field (`book.name`) in the
example. If the resource field has a word separator, `snake_case` is
used.

### Request message

Apply methods implement a common request message pattern:

```proto
message ApplyBookRequest {
  // The book to apply.
  //
  // The book's `name` field is used to identify the book to apply.
  // Format: publishers/{publisher}/books/{book}
  Book book = 1 [(google.api.field_behavior) = REQUIRED];
}
```

- The request message **must** contain a field for the resource.
  - The field **must** map to the `PUT` body.
  - The field **must** be [annotated as required][aip-203].
  - A `name` field **must** be included in the resource message. It **should**
    be called `name`.
- The Rpc **must** create the resource if it does not exist, by default.
- The request message **may** contain an `etag` field.
  - `etag` must support a special value, `*`, that is equivalent to the
    HTTP Preconditions' specficiation for the `Allow-Missing` header:
    when provided, only updates will be performed.
- The Rpc **must** support a full resource udpate and **must not**
  accept a field mask.
- The request message **must not** contain any other required fields, and
  **should not** contain other optional fields except those described in this
  or another AIP.

### Long-running apply

Some resources take longer to apply than is reasonable for a regular API
request. In this situation, the API **should** use a long-running
operation (AIP-151) instead:

```proto
rpc ApplyBook(ApplyBookRequest) returns (google.longrunning.Operation) {
  option (google.api.http) = {
    patch: "/v1/{book.name=publishers/*/books/*}"
  };
  option (google.longrunning.operation_info) = {
    response_type: "Book"
    metadata_type: "OperationMetadata"
  };
}
```

- The response type **must** be set to the resource (what the return type would
  be if the RPC was not long-running).
- Both the `response_type` and `metadata_type` fields **must** be specified.

[aip-203]: ./0203.md

## Changelog

